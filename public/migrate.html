<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Test page for hitting the API</title>
    <style>
      form fieldset { border: none; margin: 0; padding: 0; }
      form fieldset + fieldset { margin-top: 0.5em;}
      form span { display: inline-block; width: 10em; }
    </style>
  </head>
  <body>
    <h1>A test post to http://test.example.com:8000/entries</h1>

    <form name="entries" method="POST">
      <fieldset>
        <label>
          <div>JSON array of entries</div>
          <textarea style="width: 100%" rows=30 id="entryArray" name="entryArray">
          </textarea>
        </label>
      </fieldset>
      <!-- 'featured' is set through administration -->
      <fieldset>
        <input type="hidden" id="nonce" name="nonce" value="">
        <input type="hidden" id="csrf" name="csrfmiddlewaretoken" value="">
        <button id="submit" disabled="disabled">submit</button>
        <!-- this value SHOULD be set by the API server instead, but we do it here for now -->
        <input type="hidden" id="user" name="submitted_by" value="">
      </fieldset>
    </form>

  <script>

    var currentNonce,
        currentCSRF,
        currentUser;
      
    var entries;
    
    //Sample:
        //[{
        //     "title": "test full entry 1",
        //     "description": "description full entry",
        //     "tags": ["tag1", "tag2"],
        //     "interest": "interest field",
        //     "get_involved": "get involved text field",
        //     "get_involved_url": "http://example.com/getinvolved",
        //     "thumbnail_url": "http://example.com/",
        //     "content_url": "http://example.com/",
        //     "internal_notes": "Some internal notes",
        //     "featured": true,
        //     "issues": ["Decentralization"],
        //     "creators": ["Pomax", "Alan"]
        // },
        // {
        //     "title": "test full entry 2",
        //     "description": "description full entry",
        //     "tags": ["tag1", "tag2"],
        //     "interest": "interest field",
        //     "get_involved": "get involved text field",
        //     "get_involved_url": "http://example.com/getinvolved",
        //     "thumbnail_url": "http://example.com/",
        //     "content_url": "http://example.com/",
        //     "internal_notes": "Some internal notes",
        //     "featured": true,
        //     "issues": ["Decentralization"],
        //     "creators": ["Pomax", "Alan"]
        // }];

    // don't let the browser submit this form. We'll handle it.
    document.forms.entries.onsubmit = () => false;

    // as the API server for a nonce with associated csrf and user info
    var getNonce = (callback) => {
      var getnonce = new XMLHttpRequest();
      getnonce.open("GET", "http://test.example.com:8000/nonce", true);
      getnonce.onload = callback
      getnonce.withCredentials = true
      getnonce.send(null);
    }

    // put all the API server values in the form and enable submission
    var confirmAuthentication = (evt) => {
      var data = evt.target.response;
      try {
        data = JSON.parse(data);
        currentUser = data.user;
        currentNonce = data.nonce;
        currentCSRF = data.csrf_token;

        // when we have a nonce, set up actual form handling
        var btn = document.querySelector("#submit");
        btn.onclick = submitForm

        // and then allow users to hit submit
        btn.removeAttribute("disabled");
      } catch (e) {
          document.forms.entries.innerHTML = "<div>You do not appear to be logged in: please <a href='http://test.example.com:8000' target='_blank'>log in first</a>.</div>";
      }
    }

    // handler for the form submission result
    var finaliseSumbit = evt => {
      let xhr = evt.target;
      if (xhr.status === 200) {
        if(entries.length){
          getNonce(postAnEntry);
        } else {
          document.forms.entries.innerHTML = "<div>Form submitted successfully!</div>";
        }
      } else {
        console.log("Error", xhr.response);
      }
    };

    var postAnEntry = (e) => {
      setFormValues(e);
      var entry;
      if(entries.length){
        entry = entries.pop()
      }
      let submit = new XMLHttpRequest();
      submit.open("POST", "http://test.example.com:8000/entries/", true);
      submit.setRequestHeader("Content-Type", "application/json");
      submit.setRequestHeader("X-CSRFToken", currentCSRF );
      submit.onload = finaliseSumbit
      submit.withCredentials = true;
      entry.nonce = currentNonce;
      entry.csrfmiddlewaretoken = currentCSRF;
      entry.user = currentUser;
      submit.send(JSON.stringify(entry));
    } 
    // what to do when "submit" is clicked
    var submitForm = (e) => {
      entries = JSON.parse(document.getElementById("entryArray").value);
      postAnEntry(e);
    };

    var setFormValues = (evt) => {
      var data = evt.target.response;
      try {
        data = JSON.parse(data);

        currentUser = data.user;
        currentNonce = data.nonce;
        currentCSRF = data.csrf_token;
      } catch (e) {
          document.forms.entries.innerHTML = "<div>Crap, something went wrong in the middle.</div>";
      }
    }




    // Let's kick it off!
    getNonce(confirmAuthentication);
  </script>
  </body>
</html>

